generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  username      String         @unique
  passwordHash  String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  lastLogin     DateTime?

  categories      Category[]
  flashcards      Flashcard[]
  reviewSchedules ReviewSchedule[]
  reviewHistory   ReviewHistory[]
  quizSessions    QuizSession[]
  studyStreak     StudyStreak?
  dailyStats      DailyStat[]
}

model Category {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  color       String?     // hex color
  icon        String?     // emoji or icon name
  userId      Int
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcards  Flashcard[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([userId, name])
}

model Flashcard {
  id               Int              @id @default(autoincrement())
  question         String
  answer           String
  hint             String?
  questionImageUrl String?
  answerImageUrl   String?
  questionAudioUrl String?
  answerAudioUrl   String?
  difficulty       String           @default("medium") // easy, medium, hard
  tags             String[]
  userId           Int
  categoryId       Int?
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  category         Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  reviewSchedule   ReviewSchedule?
  reviewHistory    ReviewHistory[]
  quizAnswers      QuizAnswer[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([userId])
  @@index([categoryId])
}

model ReviewSchedule {
  id              Int       @id @default(autoincrement())
  easeFactor      Float     @default(2.5) // 1.3 to 2.5+
  interval        Int       @default(1)   // days
  repetitions     Int       @default(0)   // consecutive correct
  nextReviewDate  DateTime
  lastReviewedAt  DateTime?
  boxNumber       Int       @default(1)   // Leitner box (1-5)
  userId          Int
  flashcardId     Int       @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcard       Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([nextReviewDate])
}

model ReviewHistory {
  id                  Int       @id @default(autoincrement())
  quality             Int       // 0-5 SM-2 rating
  responseTimeSeconds Int?
  wasCorrect          Boolean
  easeFactorBefore    Float?
  easeFactorAfter     Float?
  intervalBefore      Int?
  intervalAfter       Int?
  boxBefore           Int?
  boxAfter            Int?
  userId              Int
  flashcardId         Int
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcard           Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  reviewedAt          DateTime  @default(now())

  @@index([userId])
  @@index([flashcardId])
}

model QuizSession {
  id              Int          @id @default(autoincrement())
  totalQuestions  Int
  correctAnswers  Int          @default(0)
  scorePercentage Float?
  categoryId      Int?
  userId          Int
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizAnswers     QuizAnswer[]
  startedAt       DateTime     @default(now())
  completedAt     DateTime?
  durationSeconds Int?

  @@index([userId])
}

model QuizAnswer {
  id               Int         @id @default(autoincrement())
  userAnswer       String?
  wasCorrect       Boolean
  timeTakenSeconds Int?
  quizSessionId    Int
  flashcardId      Int
  quizSession      QuizSession @relation(fields: [quizSessionId], references: [id], onDelete: Cascade)
  flashcard        Flashcard   @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  answeredAt       DateTime    @default(now())
}

model StudyStreak {
  id            Int      @id @default(autoincrement())
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastStudyDate DateTime?
  userId        Int      @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  updatedAt     DateTime @updatedAt
}

model DailyStat {
  id               Int      @id @default(autoincrement())
  date             DateTime @db.Date
  cardsReviewed    Int      @default(0)
  cardsLearned     Int      @default(0) // new cards
  correctAnswers   Int      @default(0)
  totalAnswers     Int      @default(0)
  studyTimeMinutes Int      @default(0)
  userId           Int
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}
